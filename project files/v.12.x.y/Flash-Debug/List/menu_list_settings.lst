###############################################################################
#
# IAR ANSI C/C++ Compiler V7.50.2.10312/W32 for ARM       24/Mar/2017  12:54:57
# Copyright 1999-2015 IAR Systems AB.
#
#    Cpu mode     =  thumb
#    Endian       =  little
#    Source file  =  
#        G:\emb_pj\CS_Demo\demo3\cs_pr_a\Device-2.12.x.y\working
#        files\src\menu_list_settings.c
#    Command line =  
#        "G:\emb_pj\CS_Demo\demo3\cs_pr_a\Device-2.12.x.y\working
#        files\src\menu_list_settings.c" -D USE_STDPERIPH_DRIVER -D STM32F2XX
#        -D USE_USB_OTG_FS -D KEYBOARD_VER_1 -D SYSTEM_VIEWER_ENABLE -lc
#        "G:\emb_pj\CS_Demo\demo3\cs_pr_a\Device-2.12.x.y\project
#        files\v.12.x.y\Flash-Debug\List" --remarks -o
#        "G:\emb_pj\CS_Demo\demo3\cs_pr_a\Device-2.12.x.y\project
#        files\v.12.x.y\Flash-Debug\Obj" --no_cse --no_unroll --no_inline
#        --no_code_motion --no_tbaa --no_clustering --no_scheduling --debug
#        --endian=little --cpu=Cortex-M3 -e --enable_multibytes --fpu=None
#        --dlib_config G:\PRG\IAR7_50_2\arm\INC\c\DLib_Config_Full.h -I
#        "G:\emb_pj\CS_Demo\demo3\cs_pr_a\Device-2.12.x.y\project
#        files\v.12.x.y\..\..\working files\inc\" -I
#        "G:\emb_pj\CS_Demo\demo3\cs_pr_a\Device-2.12.x.y\project
#        files\v.12.x.y\..\..\working files\usb\" -I
#        "G:\emb_pj\CS_Demo\demo3\cs_pr_a\Device-2.12.x.y\project
#        files\v.12.x.y\..\..\Libraries\CMSIS\Device\ST\STM32F2xx\Include\" -I
#        "G:\emb_pj\CS_Demo\demo3\cs_pr_a\Device-2.12.x.y\project
#        files\v.12.x.y\..\..\Libraries\STM32F2xx_StdPeriph_Driver\inc\" -I
#        "G:\emb_pj\CS_Demo\demo3\cs_pr_a\Device-2.12.x.y\project
#        files\v.12.x.y\..\..\Libraries\STM32_USB_OTG_Driver\inc\" -I
#        "G:\emb_pj\CS_Demo\demo3\cs_pr_a\Device-2.12.x.y\project
#        files\v.12.x.y\..\..\Libraries\STM32_USB_Device_Library\Core\inc\" -I
#        "G:\emb_pj\CS_Demo\demo3\cs_pr_a\Device-2.12.x.y\project
#        files\v.12.x.y\..\..\Libraries\STM32_USB_Device_Library\Class\cdc\inc\"
#        -I "G:\emb_pj\CS_Demo\demo3\cs_pr_a\Device-2.12.x.y\project
#        files\v.12.x.y\..\..\SystemView\Config\" -I
#        "G:\emb_pj\CS_Demo\demo3\cs_pr_a\Device-2.12.x.y\project
#        files\v.12.x.y\..\..\SystemView\OS\" -I
#        "G:\emb_pj\CS_Demo\demo3\cs_pr_a\Device-2.12.x.y\project
#        files\v.12.x.y\..\..\SystemView\SEGGER\" -On --use_c++_inline
#        --require_prototypes -I G:\PRG\IAR7_50_2\arm\CMSIS\Include\ -D
#        ARM_MATH_CM3
#    List file    =  
#        G:\emb_pj\CS_Demo\demo3\cs_pr_a\Device-2.12.x.y\project
#        files\v.12.x.y\Flash-Debug\List\menu_list_settings.lst
#    Object file  =  
#        G:\emb_pj\CS_Demo\demo3\cs_pr_a\Device-2.12.x.y\project
#        files\v.12.x.y\Flash-Debug\Obj\menu_list_settings.o
#
###############################################################################

G:\emb_pj\CS_Demo\demo3\cs_pr_a\Device-2.12.x.y\working files\src\menu_list_settings.c
      1          #include "header.h"
      2          
      3          /*****************************************************/
      4          /*
      5          Функція переміщення по меню
      6          
      7          Вхідні параметри
      8          (1 << BIT_REWRITE) - перемалювати меню
      9          (1 << BIT_KEY_DOWN) - рухатися вниз
     10          (1 << BIT_KEY_UP) - рухатися вверх
     11          */
     12          /*****************************************************/
     13          void move_into_list_settings(unsigned int action, int max_row)
     14          {
     15            __CONFIG *p_current_config;
     16            p_current_config = (current_state_menu2.edition == ED_VIEWING) ? &current_config_prt : &current_config;
     17                
     18            if (action & ((1 << BIT_REWRITE) | (1 << BIT_KEY_DOWN)))
     19            {
     20              if (action & (1 << BIT_KEY_DOWN)) current_state_menu2.index_position++;
     21              do
     22              {
     23                if(current_state_menu2.index_position >= max_row) current_state_menu2.index_position = 0;
     24                while (
     25                       (
     26                        (current_state_menu2.index_position == INDEX_LIST_SETTINGS_M2_BIOS) &&
     27                        (p_current_config->n_input == 0) &&
     28                        (p_current_config->n_output == 0) &&
     29                        (p_current_config->n_led == 0)
     30                       )
     31                       ||
     32                       (
     33                        (current_state_menu2.index_position == INDEX_LIST_SETTINGS_M2_ALARMS) &&
     34                        (p_current_config->n_alarm == 0)
     35                       )
     36                       ||
     37                       (
     38                        (current_state_menu2.index_position == INDEX_LIST_SETTINGS_M2_GROUP_ALARMS) &&
     39                        (p_current_config->n_group_alarm == 0)
     40                       )
     41                       ||
     42                       (
     43                        (current_state_menu2.index_position == INDEX_LIST_SETTINGS_M2_TIMERS) &&
     44                        (p_current_config->n_timer == 0)
     45                       )
     46                       ||
     47                       (
     48                        (current_state_menu2.index_position == INDEX_LIST_SETTINGS_M2_MEANDER) &&
     49                        (p_current_config->n_meander == 0)
     50                       )
     51                      )
     52                {
     53                  if(++current_state_menu2.index_position >= max_row) current_state_menu2.index_position = 0;
     54                }
     55              }
     56              while ((action & (1 << BIT_KEY_DOWN)) && (current_state_menu2.index_position >= max_row));
     57            }
     58            else if (action & (1 << BIT_KEY_UP))
     59            {
     60              current_state_menu2.index_position--;
     61              do
     62              {
     63                if(current_state_menu2.index_position < 0) current_state_menu2.index_position = max_row - 1;
     64                while (
     65                       (
     66                        (current_state_menu2.index_position == INDEX_LIST_SETTINGS_M2_BIOS) &&
     67                        (p_current_config->n_input == 0) &&
     68                        (p_current_config->n_output == 0) &&
     69                        (p_current_config->n_led == 0)
     70                       )
     71                       ||
     72                       (
     73                        (current_state_menu2.index_position == INDEX_LIST_SETTINGS_M2_ALARMS) &&
     74                        (p_current_config->n_alarm == 0)
     75                       )
     76                       ||
     77                       (
     78                        (current_state_menu2.index_position == INDEX_LIST_SETTINGS_M2_GROUP_ALARMS) &&
     79                        (p_current_config->n_group_alarm == 0)
     80                       )
     81                       ||
     82                       (
     83                        (current_state_menu2.index_position == INDEX_LIST_SETTINGS_M2_TIMERS) &&
     84                        (p_current_config->n_timer == 0)
     85                       )
     86                       ||
     87                       (
     88                        (current_state_menu2.index_position == INDEX_LIST_SETTINGS_M2_MEANDER) &&
     89                        (p_current_config->n_meander == 0)
     90                       )
     91                      )
     92                {
     93                  if(--current_state_menu2.index_position < 0) current_state_menu2.index_position = max_row - 1;
     94                }
     95              }
     96              while (current_state_menu2.index_position < 0);
     97            }
     98          }
     99          /*****************************************************/
    100          
    101          /*****************************************************/
    102          //Формуємо екран відображення заголовків настройок
    103          /*****************************************************/
    104          void make_ekran_list_settings(void)
    105          {
    106            if (current_state_menu2.edition == ED_CONFIRM_CHANGES)
    107            {
    108              make_ekran_ask_rewrite();
    109          
    110              //Виставляємо біт обновлення екрану
    111              new_state_keyboard |= (1<<BIT_REWRITE);
    112            }
    113            else if (
    114                     (current_state_menu2.edition == ED_WARNING_EDITION_BUSY) ||
    115                     (current_state_menu2.edition == ED_INFO)
    116                    )   
    117            {
    118              const uint8_t information_about_info[MAX_NAMBER_LANGUAGE][MAX_COL_LCD + 1] = 
    119              {
    120                "Ред.не разрешено",
    121                "Ред.не дозволене",
    122                "Ed.isn't allowed",
    123                "Ред.не разрешено",
    124              };
    125          
    126              const uint8_t information_about_error[MAX_NAMBER_LANGUAGE][MAX_COL_LCD + 1] = 
    127              {
    128                " Дин.пам.недост.",
    129                " Дин.пам.недост.",
    130                " Дин.пам.недост.",
    131                " Дин.пам.недост."
    132              };
    133          
    134              make_ekran_about_info(false, ((current_state_menu2.edition == ED_WARNING_EDITION_BUSY) ? information_about_info : information_about_error));
    135            }
    136            else
    137            {
    138              const uint8_t name_string[MAX_NAMBER_LANGUAGE][MAX_ROW_LIST_SETTINGS_M2][MAX_COL_LCD + 1] = 
    139              {
    140                {
    141                  " Конфигурация   ",
    142                  " УВВ            ",
    143                  " CЗС            ",
    144                  " ШГС            ",
    145                  " МФ-Таймера     ",
    146                  " ГПС            ",
    147                  " Параметриров.  ",
    148                  " Язык           ",
    149                  " Коммуникация   ",
    150                  " Пароли         "
    151                },
    152                {
    153                  " Конфігурація   ",
    154                  " УВВ            ",
    155                  " СЗС            ",
    156                  " ШГС            ",
    157                  " БФ-Таймери     ",
    158                  " ГПС            ",
    159                  " Параметрування ",
    160                  " Мова           ",
    161                  " Комунікація    ",
    162                  " Паролі         "
    163                },
    164                {
    165                  " Configuration  ",
    166                  " BIOS           ",
    167                  " Alarms         ",
    168                  " Gr.Alarms      ",
    169                  " MF-Timer       ",
    170                  " PSG            ",
    171                  " Parametrization",
    172                  " Language       ",
    173                  " Communication  ",
    174                  " Passwords      "
    175                },
    176                {
    177                  " Конфигурация   ",
    178                  " УВВ            ",
    179                  " CЗС            ",
    180                  " ШГС            ",
    181                  " МФ-Таймера     ",
    182                  " ГПС            ",
    183                  " Параметриров.  ",
    184                  " Язык           ",
    185                  " Коммуникация   ",
    186                  " Пароли         "
    187                }
    188              };
    189              int index_language = index_language_in_array(select_struct_settings_fix()->language);
    190          
    191              unsigned int additional_current = 0;
    192              unsigned int position_temp = current_state_menu2.index_position;
    193          
    194              __CONFIG *p_current_config;
    195              p_current_config = (current_state_menu2.edition == ED_VIEWING) ? &current_config_prt : &current_config;
    196              
    197              uint8_t name_string_tmp[MAX_ROW_LIST_SETTINGS_M2][MAX_COL_LCD + 1];
    198              for(size_t index_1 = 0; index_1 < MAX_ROW_LIST_SETTINGS_M2; index_1++)
    199              {
    200                if (
    201                    (
    202                     (index_1 == INDEX_LIST_SETTINGS_M2_BIOS) &&
    203                     (p_current_config->n_input == 0) &&
    204                     (p_current_config->n_output == 0) &&
    205                     (p_current_config->n_led == 0)
    206                    )
    207                    ||
    208                    (
    209                     (index_1 == INDEX_LIST_SETTINGS_M2_ALARMS) &&
    210                     (p_current_config->n_alarm == 0)
    211                    )
    212                    ||
    213                    (
    214                     (index_1 == INDEX_LIST_SETTINGS_M2_GROUP_ALARMS) &&
    215                     (p_current_config->n_group_alarm == 0)
    216                    )
    217                    ||
    218                    (
    219                     (index_1 == INDEX_LIST_SETTINGS_M2_TIMERS) &&
    220                     (p_current_config->n_timer == 0)
    221                    )
    222                    ||
    223                    (
    224                     (index_1 == INDEX_LIST_SETTINGS_M2_MEANDER) &&
    225                     (p_current_config->n_meander == 0)
    226                    )
    227                   )
    228                {
    229                  if ((index_1 - additional_current) < position_temp) position_temp--;
    230                  additional_current++;
    231          
    232                  for(size_t index_2 = 0; index_2 < MAX_COL_LCD; index_2++)
    233                  {
    234                    name_string_tmp[MAX_ROW_LIST_SETTINGS_M2 - additional_current][index_2] = ' ';
    235                  }
    236                  name_string_tmp[MAX_ROW_LIST_SETTINGS_M2 - additional_current][MAX_COL_LCD] = '\0';
    237                }
    238                else
    239                {
    240                  for(size_t index_2 = 0; index_2 < (MAX_COL_LCD + 1); index_2++)
    241                  {
    242                    name_string_tmp[index_1 - additional_current][index_2] = name_string[index_language][index_1][index_2];
    243                  }
    244                }
    245              }
    246              unsigned int index_in_ekran = (position_temp >> POWER_MAX_ROW_LCD) << POWER_MAX_ROW_LCD;;
    247            
    248              //Копіюємо  рядки у робочий екран
    249              for (size_t i = 0; i < MAX_ROW_LCD; i++)
    250              {
    251                //Наступні рядки треба перевірити, чи їх требе відображати у текучій коффігурації
    252                for (size_t j = 0; j < MAX_COL_LCD; j++) 
    253                {
    254                  working_ekran[i][j] = (index_in_ekran < (MAX_ROW_LIST_SETTINGS_M2 - additional_current)) ? name_string_tmp[index_in_ekran][j] : ' ';
    255                }
    256                index_in_ekran++;
    257              }
    258          
    259              /*
    260              Ящо ми відкрили це вікно з довзолом на редалування, то переводим його у режим, коли зараз режиму редагування
    261              для цього вікна немає, але у тому вікні де він буде, то перехід до нього не буде вимагати введення паролю
    262              */
    263              if (current_state_menu2.edition == ED_EDITION )
    264              {
    265                current_state_menu2.edition = ED_CAN_BE_EDITED;
    266              }
    267            
    268              //Курсор по горизонталі відображається на першій позиції
    269              current_state_menu2.position_cursor_x = 0;
    270              //Відображення курору по вертикалі
    271              current_state_menu2.position_cursor_y = position_temp & (MAX_ROW_LCD - 1);
    272              //Курсор видимий
    273              current_state_menu2.cursor_on = 1;
    274              //Курсор не мигає
    275              current_state_menu2.cursor_blinking_on = 0;
    276            }
    277            
    278            //Обновити повністю весь екран
    279            current_state_menu2.current_action = ACTION_WITH_CARRENT_EKRANE_FULL_UPDATE;
    280          }
    281          /*****************************************************/
    282          
    283          /*****************************************************/
    284          /*
    285          Натискування ESC у вікні Конфігурації
    286          */
    287          /*****************************************************/
    288          void press_esc_in_list_settings(void)
    289          {
    290            if ((config_settings_modified & MASKA_MENU_LOCKS) != 0)
    291            {
    292              if ((config_settings_modified & (MASKA_CHANGED_CONFIGURATION | MASKA_CHANGED_SETTINGS)) != 0)
    293              {
    294                if (current_state_menu2.edition == ED_CAN_BE_EDITED)
    295                {
    296                  //Треба спитатися дозвіл на внесення змін
    297                  current_state_menu2.edition = ED_CONFIRM_CHANGES;
    298                }
    299                else if (current_state_menu2.edition == ED_CONFIRM_CHANGES)
    300                {
    301                  //Треба відмініти введення нових налаштувань
    302                  unsigned int result = set_config_and_settings(0, NO_MATTER_PARAMS_FIX_CHANGES);
    303                  if (result == 0)
    304                  {
    305                    //Знімаємро режим редагування
    306                    current_state_menu2.edition = ED_VIEWING;
    307                  }
    308                  else
    309                  {
    310                    //Повідомляємо про критичну помилку
    311                    current_state_menu2.edition = ED_ERROR;
    312                  }
    313                
    314                  config_settings_modified = 0;
    315                }
    316              }
    317              else
    318              {
    319                config_settings_modified = 0;
    320              }
    321            }
    322          }
    323          /*****************************************************/
    324          
    325          /*****************************************************/
    326          //
    327          /*****************************************************/
    328          /*****************************************************/

   Maximum stack usage in bytes:

   .cstack Function
   ------- --------
    1008   make_ekran_list_settings
      1008   -> __aeabi_memcpy4
      1008   -> index_language_in_array
      1008   -> make_ekran_about_info
      1008   -> make_ekran_ask_rewrite
      1008   -> select_struct_settings_fix
       4   move_into_list_settings
       8   press_esc_in_list_settings
         8   -> set_config_and_settings


   Section sizes:

   Bytes  Function/Label
   -----  --------------
       4  ??DataTable2
       4  ??DataTable2_1
       4  ??DataTable2_2
       4  ??DataTable2_3
       4  ??DataTable2_4
       4  ??DataTable2_5
       4  ??DataTable2_6
       4  ??DataTable2_7
       4  ??DataTable2_8
       4  ??DataTable2_9
      68  ?_0
      68  ?_1
     680  ?_2
     440  make_ekran_list_settings
     382  move_into_list_settings
      96  press_esc_in_list_settings

 
 816 bytes in section .rodata
 958 bytes in section .text
 
 958 bytes of CODE  memory
 816 bytes of CONST memory

Errors: none
Warnings: none
